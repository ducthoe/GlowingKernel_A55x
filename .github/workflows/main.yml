name: Build Test Kernel

on:
  workflow_dispatch:

jobs:
  build_test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up build environment
        run: |
          sudo apt update && sudo apt upgrade -y
          sudo apt-get remove --purge -y "php*" "dotnet*" "mysql*" "clang*" "google*"
          sudo apt autoremove -y
          sudo apt install -yq tar \
            attr libelf-dev dwarves rsync libbrotli-dev \
            libgtest-dev libprotobuf-dev libunwind-dev libusb-1.0-0-dev libzstd-dev libc6-dev \
            linux-modules-extra-$(uname -r) build-essential p7zip-full libarchive-tools \
            wget unzip curl
          curl -fsSL https://bazel.build/bazel-release.pub.gpg | gpg --dearmor >bazel-archive-keyring.gpg
          sudo mv bazel-archive-keyring.gpg /usr/share/keyrings
          sudo apt update && sudo apt install apt-transport-https curl gnupg
          curl -fsSL https://bazel.build/bazel-release.pub.gpg | gpg --dearmor >bazel-archive-keyring.gpg
          sudo mv bazel-archive-keyring.gpg /usr/share/keyrings
          sudo apt update && sudo apt install bazel-5.0.0
          sudo apt update && sudo apt full-upgrade
          export PATH="$HOME/bin:$PATH"
          bazel version

      - name: Clone glowingkernel_a556e repository
        run: |
          git clone --depth=1 https://github.com/exynos1480-dev/glowingkernel_a556e.git
        working-directory: ${{ github.workspace }}

      - name: Fetch ToolChain
        run: |
          mkdir -p ~/Prebuilts
          git clone --depth=1 https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86 ~/Prebuilts/gl-clang
          rm -rf ~/Prebuilts/gl-clang/clang-3* ~/Prebuilts/gl-clang/clang-r4* ~/Prebuilts/gl-clang/clang-r51* ~/Prebuilts/gl-clang/.git
          git clone --depth=1 https://android.googlesource.com/platform/prebuilts/gas/linux-x86 ~/Prebuilts/gas/linux-x86
          rm -rf ~/Prebuilts/gas/linux-x86/.git
          git clone --depth=1 https://android.googlesource.com/platform/prebuilts/build-tools ~/Prebuilts/build-tools
          rm -rf ~/Prebuilts/build-tools/.git

      - name: Build Kernel with Bazel
        run: |
          export PATH="$HOME/bin:$PATH"
          tools/bazel run --nocheck_bzl_visibility --config=stamp --sandbox_debug --verbose_failures --debug_make_verbosity=I //projects/s5e8845:s5e8845_user_dist
        working-directory: ${{ github.workspace }}

      - name: Package Kernel with AnyKernel3
        run: |
          # Credit to Vax15k for this entire action
          git clone --branch main https://github.com/ducthoe/AnyKernel3.git ~/AnyKernel3
          mkdir -p ~/files
          ./build_kernel.sh
          cp ~/AnyKernel3/Glowing* ~/files
        working-directory: ${{ github.workspace }}

      - name: Upload Test Build
        uses: actions/upload-artifact@v4
        with:
          name: Glowing-$(date +'%Y-%m-%d')
          path: ./files/Glowing*
